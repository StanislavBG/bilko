# Bilko Bibitkov

Founding Principles: ARCH-000, ARCH-000-A, ARCH-000-B (ABSOLUTE priority)
Rules: `/rules/` — read ARCH-006 before any task
Stack: React + Tailwind + Shadcn | Express | PostgreSQL + Drizzle | Replit Auth
Preferences: Move slowly, rules-first, no over-building

## Agentic Workflows

**For n8n development**: Follow AGT-001 (`rules/agent/001-n8n-development-workflow.md`)
- 6-phase cycle: FETCH → ANALYZE → MODIFY → PUSH → BACKUP → VERIFY
- Single change per cycle, checkpoint gates between phases
- Backups saved to `server/workflows/backups/`

## Recent Changes (January 2026)

### European Football Daily Workflow - RESTRUCTURED FOR RELIABLE IMAGE GENERATION
- **Status**: Fully operational with granular, compliance-first architecture (24 nodes)
- **Architecture Philosophy**: Check compliance BEFORE topic selection, not after content creation
- **New Granular Flow** (January 25, 2026):
  1. **News Scout**: RSS → Extract Articles (fetches 5 headlines)
  2. **Topic Analyst**: Gemini extracts entities per article (people, teams, events, imageability)
  3. **Compliance Checker**: Gemini validates each topic for image safety (flags real people)
  4. **Topic Selector**: Aggregates all topics, picks BEST COMPLIANT topic
  5. **Hashtag Researcher**: Gemini finds 3 relevant, high-reach hashtags for the specific topic
  6. **Post Writer**: Creates post with the researched hashtags
  7. **Image Prompt Writer**: Generates enhanced prompt from safe concept
  8. **Call Imagen API**: Generates image (Gemini endpoint: generativelanguage.googleapis.com)
  9. **Build Final Output**: Combines post + image + transparency disclosure
- **Compliance Features**:
  1. Per-article entity extraction identifies problematic subjects EARLY
  2. Compliance validation happens BEFORE topic commitment
  3. Topic Selector only considers pre-validated compliant topics
  4. Two-post output: Main content + AI Transparency disclosure
  5. Graceful fallback when Imagen filters content
- **Key Technical Details**:
  1. Custom User-Agent header on all Google API calls (Google blocks n8n default)
  2. Imagen model: `imagen-4.0-fast-generate-001` (6s response, 1.5-1.7MB images)
  3. **CRITICAL**: Use Gemini endpoint (generativelanguage.googleapis.com), NOT Vertex AI endpoint
  4. Express body-parser limit: 10mb for base64 image payloads
  5. Strip Gemini markdown fences before JSON parsing
  6. Data path: `$json.geminiApiKey` flows through all Code nodes; use `$('NodeName').first().json` to reference previous nodes after HTTP calls
- **Workflow Nodes**: 24 total

### Execution Tracking System (January 2026) - VERIFIED
- **workflow_executions table**: Tracks execution runs with status, timestamps, and finalOutput (JSONB)
- **Traces linked by executionId**: Communication traces reference parent execution for grouping
- **Callback logic**: First callback creates execution record; final-output callback marks completion and persists output
- **API endpoints**: GET /api/workflows/:id/executions, GET /api/executions/:id
- **UI components**: ExecutionsList, ExecutionDetail with Latest/History view toggle on workflow detail page
- **Rule added**: INT-005 Callback Persistence Contract - documents API payload schemas and data flow
- **E2E Verified**: History view displays execution results with post content and image prompts correctly

### European Football Daily - Source Links + Tagline + Nano Banana Pro (January 26, 2026) - VERIFIED
- **Status**: Fully operational - Execution 93 confirmed all features working
- **New Nodes**: Generate Tagline + Parse Tagline (26 total nodes now)
- **Flow**: Parse Image Prompt → Generate Tagline → Parse Tagline → Call Imagen API
- **Image Model**: Upgraded from `imagen-4.0-fast-generate-001` to `gemini-3-pro-image-preview` (Nano Banana Pro)
- **API Format**: Uses `:generateContent` endpoint with `generation_config`, `response_modalities`, `image_config` (snake_case)
- **Tagline**: Generated by Gemini (4-5 word punchy tagline), included in image prompt as text overlay
- **Source Links**: RSS source URLs now flow through entire pipeline, appended to 2nd message as "Source: [link]"
- **Data Flow**: Extract Articles → Parse Topic Analysis (captures link via $runIndex) → all parse nodes → Build Final Output
- **n8n Escaping Learnings**: When updating node code programmatically, newlines require multi-level escaping (\\n → \\\\n depending on nesting)

### Mobile-Responsive Layout (January 2026)
- **useIsMobile hook**: Detects viewport < 768px for mobile-specific layouts
- **Agentic Workflows**: Left nav becomes Sheet overlay on mobile, triggered by menu button
- **Memory Explorer**: ActionPanel auto-collapses on mobile
- **Rules Explorer**: Partition nav, tertiary nav, and ActionPanel auto-collapse on mobile
- **Pattern**: Use useEffect to detect mobile state change and collapse panels, preserve desktop interactivity

### Dev/Prod Workflow Architecture (January 26, 2026) - SYNCED
- **Two Physical Workflows**: `[PROD] European Football Daily` (oV6WGX5uBeTZ9tRa) and `[DEV] European Football Daily` (vHafUnYAAtDX3TRO)
- **Separate Webhook Paths** (v1.3.0):
  - PROD: `/webhook/european-football-daily`
  - DEV: `/webhook/dev-european-football-daily`
  - Both can be active simultaneously - no conflicts!
- **DEV Synced from PROD** (January 26, 2026):
  - DEV now has full 24-node pipeline matching PROD structure
  - Schedule Trigger and Merge Triggers REMOVED (manual-only execution)
  - All callback nodes use dynamic URLs: `={{ $('Webhook').first().json.body.callbackUrl }}`
  - All traceId references use correct path: `json.body.traceId`
- **Callback URL Strategy**:
  - PROD workflow: Hardcoded to `https://bilkobibitkov.replit.app/api/workflows/callback`
  - DEV workflow: Dynamic URL from webhook payload (works with any dev domain)
- **Testing Procedure**: Simply trigger DEV workflow - no need to deactivate PROD

### Key n8n Learnings
1. **User-Agent Required**: Google APIs block n8n's default user-agent. Always add custom User-Agent header.
2. **Webhook Body Structure**: Data sent to webhook is at `.json.body.keyName`, not `.json.keyName`
3. **Data Flow**: API keys must be explicitly passed through all Code nodes in n8n workflows
4. **Execution Grouping**: Executions are grouped by triggerTraceId - the traceId from the initial webhook call
5. **Gemini JSON Parsing**: Gemini wraps JSON responses in markdown fences - strip with regex before parsing
6. **No JSON Sanitization Needed**: Don't sanitize structural newlines - JSON.parse() handles them correctly
7. **Imagen Safety Filters**: Imagen silently returns empty predictions (not errors) when prompts mention specific celebrities or real people - workflow should handle gracefully
8. **Dynamic Callback URLs**: For dev workflows, use `={{ $('Webhook').first().json.body.callbackUrl }}` instead of hardcoded URLs to handle changing dev domains
